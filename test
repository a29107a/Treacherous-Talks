#!/bin/bash
# This script will run local (unit/application) tests and/or integration tests.

# Get common functions
source common_bash_functions.sh

# Default settings (can be changed with command line options)
dolocal=1
dointegration=1

# Internal variables
cwd=$(pwd)
errors=0

# Get command-line arguments
while [ $# -gt 0 ]
do
    case "$1" in
        -ni) dointegration=0;;
        -nl) dolocal=0;;
        -*)  echo >&2 "usage: $0 [-ni] [-nl]"
             echo >&2 "       -ni      do not run integration tests"
             echo >&2 "       -nl      do not run local (unit) tests"
             exit 1;;
        *)   break;;
    esac
    shift
done

#################################

# Do eunit (local) tests
if [ $dolocal -eq 1 ]; then
    run_script "running eunit tests" "./rebar eunit skip_deps=true"
fi

# Do integration tests
if [ $dointegration -eq 1 ]; then

    cd $cwd
    sysrel=$cwd/system-release

    # Release and start backend
    ./release -nd backend
    start_release $sysrel "backend"

    # Release and start xmpp_frontend
    ./release -nd xmpp_frontend
    start_release $sysrel "xmpp_frontend"
    sleep 10

    # Run tests
    cd ext_test/ejabberd_echo || errors=1
    run_script "running tests" "$cwd/rebar eunit skip_deps=true"

    # Stop backend and xmpp_frontend
    stop_release $sysrel "xmpp_frontend"
    stop_release $sysrel "backend"
    cd $cwd

fi


# Exit
print_exit_status "Test run" $errors
exit $errors
