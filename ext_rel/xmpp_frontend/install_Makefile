cookiefile = installation/var/lib/ejabberd/.erlang.cookie

all: install

reinstall: clean install

# TODO: remake this target if config files change.
install/: $(beams) install-ejabberd config
	cp config/* installation/etc/ejabberd/
	cp ebin/* installation/lib/ejabberd/ebin
	rm -f $(cookiefile)
	echo "treacherous_talks" > $(cookiefile)
	chmod 700 $(cookiefile)

install-ejabberd: installation/installed-ejabberd
installation/installed-ejabberd: ejabberd/src/made
	cd ejabberd/src && make install -j4 && (cd $(CURDIR) && touch installation/installed-ejabberd)

make-ejabberd: ejabberd/src/made
ejabberd/src/made:
	cd ejabberd/src && ./configure --prefix=$(CURDIR)/installation
	cd ejabberd/src && make -j4 && touch made

clean:
	cd ejabberd/src; if [ -e Makefile ]; then make clean; fi
	rm -rf installation
	rm -f ejabberd/src/made
